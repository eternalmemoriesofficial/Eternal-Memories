<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eternal Memories Admin</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-panel {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .login-form {
            max-width: 400px;
            margin: 40px auto;
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .profile-card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .profile-card .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .add-profile {
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-form">
        <h2>Admin Login</h2>
        <div class="form-group">
            <input type="password" id="adminPassword" placeholder="Admin Password" class="form-control">
        </div>
        <button onclick="login()" class="btn btn-primary">Login</button>
    </div>

    <div id="adminPanel" class="admin-panel" style="display:none;">
        <h1>Eternal Memories Admin</h1>
        
        <div class="add-profile">
            <h2>Add New Profile</h2>
            <div class="form-group">
                <input type="text" id="newName" placeholder="Name" class="form-control">
                <input type="text" id="newRemark" placeholder="Remark" class="form-control">
                <input type="date" id="newBirthday" placeholder="Birthday" class="form-control">
                <input type="date" id="newLastday" placeholder="Last Day" class="form-control">
                <button onclick="addProfile()" class="btn btn-primary">Add Profile</button>
            </div>
        </div>

        <h2>Profiles</h2>
        <div id="profilesGrid" class="profiles-grid">
            <!-- Profiles will be loaded here -->
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let adminToken = null;

        async function login() {
            const password = document.getElementById('adminPassword').value;
            try {
                const response = await fetch(`${API_BASE_URL}/remembered/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (!response.ok) throw new Error('Login failed');
                const data = await response.json();
                adminToken = data.token;
                
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadProfiles();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function loadProfiles() {
            try {
                const response = await fetch(`${API_BASE_URL}/remembered`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                if (!response.ok) throw new Error('Failed to load profiles');
                const profiles = await response.json();
                
                const grid = document.getElementById('profilesGrid');
                grid.innerHTML = '';
                
                profiles.forEach(profile => {
                    const card = document.createElement('div');
                    card.className = 'profile-card';
                    card.innerHTML = `
                        <h3>${escapeHtml(profile.name)}</h3>
                        <p>${escapeHtml(profile.remark || '')}</p>
                        <div>Birthday: ${profile.birthday ? new Date(profile.birthday).toLocaleDateString() : 'N/A'}</div>
                        <div>Last Day: ${profile.lastday ? new Date(profile.lastday).toLocaleDateString() : 'N/A'}</div>
                        <div class="actions">
                            <button onclick="editProfile(${profile.id})" class="btn">Edit</button>
                            <button onclick="deleteProfile(${profile.id})" class="btn btn-danger">Delete</button>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                alert('Failed to load profiles: ' + error);
            }
        }

        async function addProfile() {
            const name = document.getElementById('newName').value;
            const remark = document.getElementById('newRemark').value;
            const birthday = document.getElementById('newBirthday').value;
            const lastday = document.getElementById('newLastday').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/remembered`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ name, remark, birthday, lastday })
                });
                
                if (!response.ok) throw new Error('Failed to add profile');
                await loadProfiles();
                
                // Clear form
                document.getElementById('newName').value = '';
                document.getElementById('newRemark').value = '';
                document.getElementById('newBirthday').value = '';
                document.getElementById('newLastday').value = '';
            } catch (error) {
                alert('Failed to add profile: ' + error.message);
            }
        }

        async function editProfile(id) {
            const name = prompt('Enter new name:');
            if (!name) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/remembered/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ name })
                });
                
                if (!response.ok) throw new Error('Failed to update profile');
                await loadProfiles();
            } catch (error) {
                alert('Failed to update profile: ' + error.message);
            }
        }

        async function deleteProfile(id) {
            if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/remembered/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (!response.ok) throw new Error('Failed to delete profile');
                await loadProfiles();
            } catch (error) {
                alert('Failed to delete profile: ' + error.message);
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>